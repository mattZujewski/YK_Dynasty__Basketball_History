<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YK Dynasty Basketball</title>
  <script>if(localStorage.getItem('yk_theme')==='dark')document.documentElement.classList.add('dark');</script>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <script src="js/nav.js"></script>

  <main class="page-container">
    <header class="page-header">
      <h1>&#x1F3C0; YK Dynasty Basketball</h1>
      <p class="subtitle" id="index-subtitle">Loading&hellip;</p>
    </header>

    <!-- Stat Bar (dynamic) -->
    <div class="stat-bar" id="stat-bar"></div>

    <!-- Dashboard Navigation Cards -->
    <div class="dashboard-grid">
      <a class="dashboard-card" href="standings.html">
        <div class="card-icon">&#x1F3C6;</div>
        <div class="card-title">All-Time Standings</div>
        <div class="card-desc">
          Aggregate win-loss records by owner across all Fantrax seasons,
          sorted by winning percentage.
        </div>
        <span class="card-tag">By Owner</span>
      </a>
      <a class="dashboard-card" href="trade.html">
        <div class="card-icon">&#x1F504;</div>
        <div class="card-title">Trade Log</div>
        <div class="card-desc">
          Every trade across all seasons. Filter by year, browse the full
          history, and see who's dealing the most.
        </div>
        <span class="card-tag" id="card-trade-tag">Trades</span>
      </a>
      <a class="dashboard-card" href="picks.html">
        <div class="card-icon">&#x1F4CB;</div>
        <div class="card-title">Draft Picks</div>
        <div class="card-desc">
          Who owns which future picks from 2027&ndash;2031. The ultimate
          war chest tracker for dynasty managers.
        </div>
        <span class="card-tag">5-Year Grid</span>
      </a>
      <a class="dashboard-card" href="roster.html">
        <div class="card-icon">&#x1F4DD;</div>
        <div class="card-title">Rosters</div>
        <div class="card-desc">
          Current 2025&ndash;26 rosters pulled from Fantrax. See every
          player on every team.
        </div>
        <span class="card-tag">Live Data</span>
      </a>
      <a class="dashboard-card" href="team.html">
        <div class="card-icon">&#x1F464;</div>
        <div class="card-title">Team Profiles</div>
        <div class="card-desc">
          Detailed owner profiles with season history, trade logs,
          draft picks, and current roster.
        </div>
        <span class="card-tag">10 Owners</span>
      </a>
    </div>

    <!-- Owner Overview Table -->
    <div class="chart-section" id="owner-overview-section" style="display:none">
      <h2>&#x1F4CA; Owner Overview</h2>
      <p class="chart-description">Aggregate stats for each franchise. Click an owner to view their full profile.</p>
      <div class="data-table-wrapper">
        <table class="data-table" id="owner-overview-table">
          <thead>
            <tr>
              <th data-sort="owner">Owner</th>
              <th data-sort="w" style="text-align:center">W</th>
              <th data-sort="l" style="text-align:center">L</th>
              <th data-sort="pct" style="text-align:center">Win %</th>
              <th data-sort="titles" style="text-align:center">Titles</th>
              <th data-sort="trades" style="text-align:center">Trades</th>
            </tr>
          </thead>
          <tbody id="owner-overview-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Champion History -->
    <div class="chart-section">
      <h2>&#x1F3C6; Champion History</h2>
      <p class="chart-description">League champions by season. Only the elite.</p>
      <div class="data-table-wrapper">
        <table class="data-table" id="champ-table">
          <thead>
            <tr>
              <th>Season</th>
              <th>Champion</th>
              <th>Owner</th>
              <th>Record</th>
              <th>FPTS</th>
            </tr>
          </thead>
          <tbody id="champ-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Season Standings Switcher -->
    <div class="chart-section">
      <h2>Season Standings</h2>
      <p class="chart-description">Click a season to view standings for that year.</p>
      <div class="filter-bar" id="season-filter-bar">
        <label>Season:</label>
      </div>
      <div class="data-table-wrapper">
        <table class="data-table" id="standings-table">
          <thead>
            <tr>
              <th data-sort="rank">Rank</th>
              <th data-sort="team">Team</th>
              <th data-sort="owner">Owner</th>
              <th data-sort="w">W</th>
              <th data-sort="l">L</th>
              <th data-sort="pct">Win %</th>
              <th data-sort="fpts">FPTS</th>
            </tr>
          </thead>
          <tbody id="standings-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Franchise History: Inherited Slot -->
    <div class="chart-section">
      <h2>&#x1F504; Franchise History: The Inherited Slot</h2>
      <p class="chart-description">One franchise slot, three different owners over the league's history.</p>
      <div class="data-table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Period</th>
              <th>Owner</th>
              <th>Team Names</th>
              <th>Excel Abbrev</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>2020&ndash;2022</strong></td>
              <td>Spencer Vlandis</td>
              <td style="color:var(--text-muted)">&mdash;</td>
              <td><code>VLAND</code></td>
            </tr>
            <tr>
              <td><strong>2023&ndash;2024</strong></td>
              <td>Brendan Kelley</td>
              <td>BKs Whoppers</td>
              <td><code>KELL</code></td>
            </tr>
            <tr>
              <td><strong>2024&ndash;present</strong></td>
              <td>Sam Baden</td>
              <td>Flaming Flaggs</td>
              <td><code>BADEN</code></td>
            </tr>
          </tbody>
        </table>
      </div>
      <p class="chart-insight">
        All trades under <strong>VLAND</strong>, <strong>KELL</strong>, and <strong>BADEN</strong> abbreviations
        are attributed to this single franchise slot throughout the site.
      </p>
    </div>

    <!-- Dynasty Rankings (Top 20) -->
    <div class="chart-section">
      <h2>&#x1F451; Dynasty Player Rankings</h2>
      <p class="chart-description">Lawson Rankings &mdash; January 2026 Top 20</p>
      <div class="data-table-wrapper">
        <table class="data-table" id="rankings-table">
          <thead>
            <tr>
              <th style="width:60px">Rank</th>
              <th>Player</th>
            </tr>
          </thead>
          <tbody id="rankings-tbody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="js/charts.js"></script>
  <script>
    (async function () {
      const YK = window.YK;

      let seasonsData, tradesData, rankingsData;
      try {
        [seasonsData, tradesData, rankingsData] = await Promise.all([
          YK.loadJSON('data/seasons.json'),
          YK.loadJSON('data/trades.json'),
          YK.loadJSON('data/rankings.json'),
        ]);
      } catch (e) {
        console.error('Failed to load data:', e);
        return;
      }

      const seasons = seasonsData.seasons;

      // Dynamic subtitle
      document.getElementById('index-subtitle').innerHTML =
        'Fantrax NBA Dynasty League &middot; Est. 2020 &middot; ' + seasons.length + ' Seasons';

      // Dynamic stat bar
      const champCount = seasons.filter(function(s) { return s.champion; }).length;
      document.getElementById('stat-bar').innerHTML =
        '<div class="stat-card">' +
          '<span class="stat-label">Seasons</span>' +
          '<span class="stat-value">' + seasons.length + '</span>' +
        '</div>' +
        '<div class="stat-card">' +
          '<span class="stat-label">Franchises</span>' +
          '<span class="stat-value gold">10</span>' +
        '</div>' +
        '<div class="stat-card">' +
          '<span class="stat-label">Total Trades</span>' +
          '<span class="stat-value">' + tradesData.length + '</span>' +
        '</div>' +
        '<div class="stat-card">' +
          '<span class="stat-label">Champions</span>' +
          '<span class="stat-value gold">' + champCount + '</span>' +
        '</div>';

      document.getElementById('card-trade-tag').textContent = tradesData.length + ' Trades';

      // --- Owner Overview Table ---
      // Parse canonical owner from trade string
      function parseOwner(str) {
        var parts = str.trim().split(/\s+/);
        return YK.resolveOwner(parts[0]);
      }

      // Count trades per owner
      var tradeCounts = {};
      tradesData.forEach(function(trade) {
        var owners = new Set();
        (trade.give || []).concat(trade.get || []).forEach(function(item) {
          var owner = parseOwner(item);
          if (owner && YK.OWNERS_ALPHA.includes(owner)) owners.add(owner);
        });
        owners.forEach(function(o) { tradeCounts[o] = (tradeCounts[o] || 0) + 1; });
      });

      // Aggregate W/L/Titles by owner
      var ownerStats = {};
      YK.OWNERS_ALPHA.forEach(function(o) {
        ownerStats[o] = { w: 0, l: 0, titles: 0, pct: 0 };
      });

      seasons.forEach(function(season) {
        season.standings.forEach(function(entry) {
          var owner = YK.teamToOwner(entry.team);
          if (!owner || !ownerStats[owner]) return;
          ownerStats[owner].w += entry.w;
          ownerStats[owner].l += entry.l;
          if (season.champion === entry.team) ownerStats[owner].titles++;
        });
      });

      Object.keys(ownerStats).forEach(function(o) {
        var s = ownerStats[o];
        s.pct = (s.w + s.l) > 0 ? s.w / (s.w + s.l) : 0;
      });

      // Sort by win%
      var sortedOverview = YK.OWNERS_ALPHA.slice().sort(function(a, b) {
        return ownerStats[b].pct - ownerStats[a].pct || ownerStats[b].w - ownerStats[a].w;
      });

      var overviewTbody = document.getElementById('owner-overview-tbody');
      overviewTbody.innerHTML = sortedOverview.map(function(owner) {
        var s = ownerStats[owner];
        var color = YK.ownerColor(owner);
        var displayName = YK.ownerDisplayName(owner);
        var tc = tradeCounts[owner] || 0;
        return '<tr class="clickable" data-owner="' + displayName + '" data-w="' + s.w + '" data-l="' + s.l + '" data-pct="' + s.pct.toFixed(3) + '" data-titles="' + s.titles + '" data-trades="' + tc + '" onclick="window.location.href=\'team.html?owner=' + owner + '\'">' +
          '<td>' +
            '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:' + color + ';margin-right:7px;vertical-align:middle"></span>' +
            '<strong>' + displayName + '</strong>' +
            (s.titles > 0 ? ' <span class="badge badge-champ">' + s.titles + 'x</span>' : '') +
          '</td>' +
          '<td style="text-align:center;font-weight:600">' + s.w + '</td>' +
          '<td style="text-align:center">' + s.l + '</td>' +
          '<td style="text-align:center;font-weight:700;color:var(--brand-green)">' + (s.pct * 100).toFixed(1) + '%</td>' +
          '<td style="text-align:center">' + (s.titles > 0 ? s.titles : '&mdash;') + '</td>' +
          '<td style="text-align:center">' + tc + '</td>' +
        '</tr>';
      }).join('');

      document.getElementById('owner-overview-section').style.display = 'block';
      YK.makeSortable(document.getElementById('owner-overview-table'));

      // Champion table
      var champTbody = document.getElementById('champ-tbody');
      var champs = seasons.filter(function(s) { return s.champion; });
      champTbody.innerHTML = champs.map(function(s) {
        var winner = s.standings.find(function(t) { return t.team === s.champion; });
        var owner = YK.teamToOwner(s.champion);
        var ownerDisplay = owner ? YK.ownerDisplayName(owner) : '&mdash;';
        var color = owner ? YK.ownerColor(owner) : '#888';
        return '<tr>' +
          '<td><strong>' + s.year + '</strong></td>' +
          '<td><span class="badge badge-champ">' + s.champion + '</span></td>' +
          '<td>' +
            '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + color + ';margin-right:6px;vertical-align:middle"></span>' +
            ownerDisplay +
          '</td>' +
          '<td>' + (winner ? winner.w + '-' + winner.l : '&mdash;') + '</td>' +
          '<td>' + (winner ? winner.fpts.toLocaleString() : '&mdash;') + '</td>' +
        '</tr>';
      }).join('');

      // Season standings switcher
      var filterBar = document.getElementById('season-filter-bar');
      var standingsTbody = document.getElementById('standings-tbody');

      function renderStandings(season) {
        var s = seasons.find(function(x) { return x.year === season; });
        if (!s) return;
        standingsTbody.innerHTML = s.standings.map(function(t) {
          var isChamp = t.team === s.champion;
          var owner = YK.teamToOwner(t.team);
          var ownerDisplay = owner ? YK.ownerDisplayName(owner) : '&mdash;';
          var color = owner ? YK.ownerColor(owner) : '#888';
          return '<tr data-rank="' + t.rank + '" data-team="' + t.team + '" data-owner="' + ownerDisplay + '" data-w="' + t.w + '" data-l="' + t.l + '" data-pct="' + t.win_pct + '" data-fpts="' + t.fpts + '">' +
            '<td style="text-align:center;font-weight:700">' + t.rank + '</td>' +
            '<td>' +
              (isChamp ? '<span style="color:var(--brand-gold);margin-right:4px">&#x1F3C6;</span>' : '') +
              '<strong>' + t.team + '</strong>' +
              (s.in_progress && t.rank === 1 ? ' <span class="badge badge-active" style="margin-left:6px">IN PROGRESS</span>' : '') +
            '</td>' +
            '<td>' +
              '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + color + ';margin-right:6px;vertical-align:middle"></span>' +
              ownerDisplay +
            '</td>' +
            '<td style="text-align:center">' + t.w + '</td>' +
            '<td style="text-align:center">' + t.l + '</td>' +
            '<td style="text-align:center;font-weight:600">' + (t.win_pct * 100).toFixed(1) + '%</td>' +
            '<td style="text-align:right">' + t.fpts.toLocaleString() + '</td>' +
          '</tr>';
        }).join('');
      }

      seasons.forEach(function(s, i) {
        var btn = document.createElement('button');
        btn.className = 'filter-btn' + (i === seasons.length - 1 ? ' active' : '');
        btn.textContent = s.year;
        btn.addEventListener('click', function() {
          filterBar.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          renderStandings(s.year);
        });
        filterBar.appendChild(btn);
      });

      renderStandings(seasons[seasons.length - 1].year);
      YK.makeSortable(document.getElementById('standings-table'));

      // Dynasty rankings (top 20)
      var rankingsTbody = document.getElementById('rankings-tbody');
      rankingsTbody.innerHTML = rankingsData.rankings.slice(0, 20).map(function(r) {
        return '<tr>' +
          '<td style="text-align:center;font-weight:700;color:var(--brand-green)">' + r.rank + '</td>' +
          '<td>' + r.player + '</td>' +
        '</tr>';
      }).join('');
    })();
  </script>
</body>
</html>
