<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade Log &mdash; YK Dynasty Basketball</title>
  <script>if(localStorage.getItem('yk_theme')==='dark')document.documentElement.classList.add('dark');</script>
  <link rel="stylesheet" href="css/style.css" />
  <script src="js/chart.umd.min.js"></script>
  <script src="js/chartjs-fix.js"></script>
</head>
<body>
  <script src="js/nav.js"></script>

  <main class="page-container">
    <header class="page-header">
      <h1>&#x1F504; Trade Log</h1>
      <p class="subtitle" id="trade-subtitle">Loading&hellip;</p>
    </header>

    <!-- Filter Bar -->
    <div class="chart-section" style="padding:18px 24px">
      <div class="filter-bar" id="season-filter-bar">
        <label>Season:</label>
      </div>
      <div class="filter-bar" style="margin-top:8px" id="owner-filter-bar">
        <label>Owner:</label>
        <select class="filter-select" id="owner-filter">
          <option value="all">All Owners</option>
        </select>
      </div>
    </div>

    <!-- Trades by Season Chart -->
    <div class="chart-section">
      <h2>Trades by Season</h2>
      <p class="chart-description">Number of trades in each season.</p>
      <div class="chart-wrapper" style="height:300px">
        <canvas id="chart-trades-by-season"></canvas>
      </div>
    </div>

    <!-- Trade Volume by Owner Chart -->
    <div class="chart-section">
      <h2>Trade Volume by Owner</h2>
      <p class="chart-description">How many trades each owner has participated in (filtered view).</p>
      <div class="chart-wrapper" style="height:360px">
        <canvas id="chart-trade-volume"></canvas>
      </div>
      <p class="chart-insight" id="insight-volume"></p>
    </div>

    <!-- Trade Partner Matrix -->
    <div class="chart-section">
      <h2>&#x1F91D; Trade Partner Matrix</h2>
      <p class="chart-description">How many trades each pair of owners has made together. Hover for details.</p>
      <div class="data-table-wrapper" style="border:none">
        <div id="matrix-container">
          <div class="loading-spinner"><div class="spinner"></div> Loading&hellip;</div>
        </div>
      </div>
    </div>

    <!-- Trade Events List -->
    <div class="chart-section">
      <h2>Trade Events</h2>
      <p class="chart-description">
        <span id="trade-count">Loading&hellip;</span>
      </p>
      <div class="data-table-wrapper">
        <table class="data-table" id="trade-table">
          <thead>
            <tr>
              <th style="width:85px" data-sort="season">Season</th>
              <th style="width:90px" data-sort="date">Date</th>
              <th>Give</th>
              <th>Get</th>
            </tr>
          </thead>
          <tbody id="trade-tbody">
            <tr><td colspan="4" class="text-center text-muted" style="padding:24px">Loading&hellip;</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Matrix Tooltip -->
  <div class="matrix-tooltip" id="matrix-tooltip">
    <div class="tooltip-title"></div>
    <div class="tooltip-body"></div>
  </div>

  <script src="js/core.js"></script>
  <script>
    (async function () {
      const YK = window.YK;
      YK.applyChartDefaults();

      let trades;
      try {
        trades = await YK.loadJSON('data/trades.json');
      } catch (e) {
        console.error('Failed to load trades:', e);
        return;
      }

      // Dynamic subtitle
      var allSeasons = [];
      var seasonSet = {};
      trades.forEach(function(t) {
        if (!seasonSet[t.season]) { seasonSet[t.season] = true; allSeasons.push(t.season); }
      });
      allSeasons.sort();
      document.getElementById('trade-subtitle').innerHTML =
        'Every trade across ' + allSeasons.length + ' seasons of YK Dynasty Basketball';

      var activeSeason = 'all';
      var activeOwner = 'all';

      // Build season filter buttons
      var filterBar = document.getElementById('season-filter-bar');
      var allBtn = document.createElement('button');
      allBtn.className = 'filter-btn active';
      allBtn.textContent = 'All';
      allBtn.addEventListener('click', function() {
        activeSeason = 'all';
        filterBar.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
        allBtn.classList.add('active');
        render();
      });
      filterBar.appendChild(allBtn);

      allSeasons.forEach(function(s) {
        var btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.textContent = s;
        btn.addEventListener('click', function() {
          activeSeason = s;
          filterBar.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          render();
        });
        filterBar.appendChild(btn);
      });

      // Build owner filter dropdown
      var ownerSelect = document.getElementById('owner-filter');
      YK.OWNERS_ALPHA.forEach(function(owner) {
        var opt = document.createElement('option');
        opt.value = owner;
        opt.textContent = YK.ownerDisplayName(owner);
        ownerSelect.appendChild(opt);
      });
      ownerSelect.addEventListener('change', function() {
        activeOwner = ownerSelect.value;
        render();
      });

      // Parse canonical owner from trade string: "ABBREV Player Name"
      function parseOwner(str) {
        var parts = str.trim().split(/\s+/);
        return YK.resolveOwner(parts[0]);
      }

      // Get asset name without abbreviation prefix
      function parseAsset(str) {
        var parts = str.trim().split(/\s+/);
        return parts.slice(1).join(' ');
      }

      // Get filtered trades
      function getFilteredTrades() {
        var filtered = trades;
        if (activeSeason !== 'all') {
          filtered = filtered.filter(function(t) { return t.season === activeSeason; });
        }
        if (activeOwner !== 'all') {
          filtered = filtered.filter(function(t) {
            var involved = false;
            (t.give || []).concat(t.get || []).forEach(function(item) {
              if (parseOwner(item) === activeOwner) involved = true;
            });
            return involved;
          });
        }
        return filtered;
      }

      // Find all owners involved in a trade
      function tradeOwners(trade) {
        var owners = new Set();
        (trade.give || []).concat(trade.get || []).forEach(function(item) {
          var o = parseOwner(item);
          if (o && YK.OWNERS_ALPHA.includes(o)) owners.add(o);
        });
        return Array.from(owners);
      }

      // Count trades per canonical owner
      function countByOwner(filtered) {
        var counts = {};
        filtered.forEach(function(trade) {
          var owners = new Set();
          (trade.give || []).concat(trade.get || []).forEach(function(item) {
            var owner = parseOwner(item);
            if (owner && YK.OWNERS_ALPHA.includes(owner)) owners.add(owner);
          });
          owners.forEach(function(o) { counts[o] = (counts[o] || 0) + 1; });
        });
        return counts;
      }

      var volumeChart = null;
      var seasonChart = null;

      // --- Trades by Season chart (always shows full data) ---
      function renderSeasonChart() {
        var seasonCounts = {};
        allSeasons.forEach(function(s) { seasonCounts[s] = 0; });
        trades.forEach(function(t) { seasonCounts[t.season] = (seasonCounts[t.season] || 0) + 1; });

        var labels = allSeasons;
        var data = allSeasons.map(function(s) { return seasonCounts[s]; });

        if (seasonChart) seasonChart.destroy();
        seasonChart = new Chart(document.getElementById('chart-trades-by-season').getContext('2d'), {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: 'rgba(26,107,60,0.7)',
              borderColor: 'var(--brand-green)',
              borderWidth: 1,
              borderRadius: 4,
            }],
          },
          options: YK.barOptions({ yLabel: 'Trades' }),
        });
      }

      function render() {
        var filtered = getFilteredTrades();

        // Trade count label
        document.getElementById('trade-count').textContent =
          filtered.length + ' trade' + (filtered.length !== 1 ? 's' : '') +
          (activeSeason !== 'all' ? ' in ' + activeSeason : ' across all seasons') +
          (activeOwner !== 'all' ? ' involving ' + YK.ownerDisplayName(activeOwner) : '');

        // Render trade table
        var tbody = document.getElementById('trade-tbody');
        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted" style="padding:24px">No trades found</td></tr>';
        } else {
          tbody.innerHTML = filtered.map(function(trade) {
            var giveStr = (trade.give || []).map(function(g) {
              var owner = parseOwner(g);
              var color = YK.ownerColor(owner);
              var lastName = (YK.ownerDisplayName(owner) || '').split(' ').pop();
              var asset = parseAsset(g);
              return '<div style="margin-bottom:2px">' +
                '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:' + color + ';margin-right:4px;vertical-align:middle"></span>' +
                '<span style="color:var(--text-muted);font-weight:600;font-size:0.75rem">' + escapeHtml(lastName) + '</span> ' +
                escapeHtml(asset) +
              '</div>';
            }).join('');
            var getStr = (trade.get || []).map(function(g) {
              var owner = parseOwner(g);
              var color = YK.ownerColor(owner);
              var lastName = (YK.ownerDisplayName(owner) || '').split(' ').pop();
              var asset = parseAsset(g);
              return '<div style="margin-bottom:2px">' +
                '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:' + color + ';margin-right:4px;vertical-align:middle"></span>' +
                '<span style="color:var(--text-muted);font-weight:600;font-size:0.75rem">' + escapeHtml(lastName) + '</span> ' +
                escapeHtml(asset) +
              '</div>';
            }).join('');
            return '<tr data-season="' + trade.season + '" data-date="' + (trade.date || '') + '">' +
              '<td><strong>' + trade.season + '</strong></td>' +
              '<td style="white-space:nowrap;color:var(--text-muted);font-size:0.8rem">' + (trade.date || '&mdash;') + '</td>' +
              '<td style="font-size:0.82rem">' + giveStr + '</td>' +
              '<td style="font-size:0.82rem">' + getStr + '</td>' +
            '</tr>';
          }).join('');
        }

        // Render volume bar chart â€” use display names
        var counts = countByOwner(filtered);
        var sortedOwners = Object.keys(counts).sort(function(a, b) { return counts[b] - counts[a]; });
        var labels = sortedOwners.map(function(o) { return YK.ownerDisplayName(o); });
        var data = sortedOwners.map(function(o) { return counts[o]; });
        var colors = sortedOwners.map(function(o) { return YK.ownerColor(o); });

        if (volumeChart) volumeChart.destroy();

        volumeChart = new Chart(document.getElementById('chart-trade-volume').getContext('2d'), {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors,
              borderColor: colors,
              borderWidth: 1,
              borderRadius: 4,
            }],
          },
          options: {
            ...YK.barOptions({ yLabel: 'Number of Trades' }),
            scales: {
              ...YK.barOptions({ yLabel: 'Number of Trades' }).scales,
              x: {
                ...YK.barOptions({}).scales.x,
                ticks: { maxRotation: 45, font: { size: 10 } },
              },
            },
          },
        });

        // Insight
        if (sortedOwners.length > 0) {
          var topOwner = sortedOwners[0];
          document.getElementById('insight-volume').innerHTML =
            '<strong>' + YK.ownerDisplayName(topOwner) + '</strong> leads with <strong>' + counts[topOwner] + '</strong> trade participations' +
            (activeSeason !== 'all' ? ' in ' + activeSeason : ' across all seasons') + '.';
        }

        // Render trade partner matrix
        renderMatrix(filtered);
      }

      // --- Trade Partner Matrix ---
      function renderMatrix(filtered) {
        var owners = YK.OWNERS_ALPHA.slice();
        // Build matrix: matrix[a][b] = [trade objects]
        var matrix = {};
        owners.forEach(function(a) {
          matrix[a] = {};
          owners.forEach(function(b) { matrix[a][b] = []; });
        });

        filtered.forEach(function(trade) {
          var involved = tradeOwners(trade);
          // For each pair
          for (var i = 0; i < involved.length; i++) {
            for (var j = i + 1; j < involved.length; j++) {
              matrix[involved[i]][involved[j]].push(trade);
              matrix[involved[j]][involved[i]].push(trade);
            }
          }
        });

        // Find max for "hot" threshold
        var maxCount = 0;
        owners.forEach(function(a) {
          owners.forEach(function(b) {
            if (a !== b && matrix[a][b].length > maxCount) maxCount = matrix[a][b].length;
          });
        });
        var hotThreshold = Math.max(3, Math.ceil(maxCount * 0.6));

        var container = document.getElementById('matrix-container');
        var cols = owners.length + 1;
        var html = '<div class="trade-matrix" style="grid-template-columns: 110px repeat(' + owners.length + ', 1fr);">';

        // Header row
        html += '<div class="trade-matrix-cell header"></div>';
        owners.forEach(function(o) {
          var last = YK.ownerDisplayName(o).split(' ').pop();
          html += '<div class="trade-matrix-cell header">' + last + '</div>';
        });

        // Data rows
        owners.forEach(function(rowOwner) {
          var last = YK.ownerDisplayName(rowOwner).split(' ').pop();
          var color = YK.ownerColor(rowOwner);
          html += '<div class="trade-matrix-cell row-label">' +
            '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + color + ';margin-right:4px;vertical-align:middle"></span>' +
            last + '</div>';

          owners.forEach(function(colOwner) {
            if (rowOwner === colOwner) {
              html += '<div class="trade-matrix-cell diagonal">&mdash;</div>';
            } else {
              var count = matrix[rowOwner][colOwner].length;
              if (count === 0) {
                html += '<div class="trade-matrix-cell empty">0</div>';
              } else {
                var cls = count >= hotThreshold ? 'has-trades hot' : 'has-trades';
                html += '<div class="trade-matrix-cell ' + cls + '" data-row="' + rowOwner + '" data-col="' + colOwner + '" data-count="' + count + '">' + count + '</div>';
              }
            }
          });
        });

        html += '</div>';
        container.innerHTML = html;

        // Tooltip hover handlers
        var tooltip = document.getElementById('matrix-tooltip');
        container.querySelectorAll('.trade-matrix-cell.has-trades').forEach(function(cell) {
          cell.addEventListener('mouseenter', function(e) {
            var row = cell.dataset.row;
            var col = cell.dataset.col;
            var tradeList = matrix[row][col];
            var titleHtml = YK.ownerDisplayName(row) + ' &harr; ' + YK.ownerDisplayName(col) + ' (' + tradeList.length + ' trade' + (tradeList.length !== 1 ? 's' : '') + ')';
            var bodyHtml = tradeList.slice(0, 5).map(function(t) {
              return '<div class="tooltip-item">' + t.season + (t.date ? ' (' + t.date + ')' : '') + '</div>';
            }).join('');
            if (tradeList.length > 5) bodyHtml += '<div class="tooltip-item" style="color:var(--text-muted)">...and ' + (tradeList.length - 5) + ' more</div>';

            tooltip.querySelector('.tooltip-title').innerHTML = titleHtml;
            tooltip.querySelector('.tooltip-body').innerHTML = bodyHtml;
            tooltip.classList.add('visible');

            var rect = cell.getBoundingClientRect();
            tooltip.style.left = Math.min(rect.left, window.innerWidth - 340) + 'px';
            tooltip.style.top = (rect.bottom + 8) + 'px';
          });
          cell.addEventListener('mouseleave', function() {
            tooltip.classList.remove('visible');
          });
        });
      }

      function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      renderSeasonChart();
      render();
      YK.makeSortable(document.getElementById('trade-table'));
    })();
  </script>
</body>
</html>
