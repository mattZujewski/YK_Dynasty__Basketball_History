<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Profiles &mdash; YK Dynasty Basketball</title>
  <script>if(localStorage.getItem('yk_theme')==='dark')document.documentElement.classList.add('dark');</script>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <script src="js/nav.js"></script>

  <main class="page-container">
    <header class="page-header">
      <h1>&#x1F464; Team Profiles</h1>
      <p class="subtitle">Full franchise breakdown for each owner</p>
    </header>

    <!-- Owner Selector -->
    <div class="owner-select-bar">
      <label>Owner:</label>
      <select id="owner-select"></select>
    </div>

    <!-- Profile Content -->
    <div id="team-profile">
      <div class="loading-spinner"><div class="spinner"></div> Loading&hellip;</div>
    </div>
  </main>

  <script src="js/core.js"></script>
  <script>
    (async function () {
      const YK = window.YK;

      let seasonsData, tradesData, picksData, rosterData, ownersData, rankingsData;
      try {
        [seasonsData, tradesData, picksData, rosterData, ownersData, rankingsData] = await Promise.all([
          YK.loadJSON('data/seasons.json'),
          YK.loadJSON('data/trades.json'),
          YK.loadJSON('data/picks.json'),
          YK.loadJSON('data/rosters_2025_26.json').catch(function() { return null; }),
          YK.loadJSON('data/owners.json'),
          YK.loadJSON('data/rankings.json'),
        ]);
      } catch (e) {
        console.error('Failed to load data:', e);
        document.getElementById('team-profile').innerHTML = '<div class="error-msg">Failed to load data.</div>';
        return;
      }

      var seasons = seasonsData.seasons;
      var owners = YK.OWNERS_ALPHA.slice();

      // Build rankings lookup
      function normalizeName(str) {
        return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
      }
      var rankMap = {};
      (rankingsData.rankings || []).forEach(function(r) {
        rankMap[normalizeName(r.player)] = r.rank;
      });

      // Parse owner from trade string
      function parseOwner(str) {
        var parts = str.trim().split(/\s+/);
        return YK.resolveOwner(parts[0]);
      }
      function parseAsset(str) {
        return str.trim().split(/\s+/).slice(1).join(' ');
      }

      // Classify pick
      function classifyPick(pickStr, holderOwner) {
        var isSwap = pickStr.includes('*') || pickStr.toLowerCase().includes('swap');
        if (isSwap) return 'pick-swap';
        var match = pickStr.match(/(?:1st|2nd)\s+Round\s+(\w+)/i);
        if (match) {
          var original = YK.resolveOwner(match[1]);
          if (original === holderOwner) return 'pick-own';
          return 'pick-acquired';
        }
        return 'pick-own';
      }

      // Status badge
      function statusBadge(status) {
        if (!status) return '';
        switch (status.toUpperCase()) {
          case 'ACTIVE':          return '<span class="badge badge-active">Active</span>';
          case 'RESERVE':         return '<span class="badge badge-reserve">Reserve</span>';
          case 'INJURED_RESERVE': return '<span class="badge badge-ir">IR</span>';
          case 'MINORS':          return '<span class="badge badge-minors">Minors</span>';
          default:                return '<span class="badge">' + escapeHtml(status) + '</span>';
        }
      }

      function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      // Build owner select dropdown
      var select = document.getElementById('owner-select');
      owners.forEach(function(o) {
        var opt = document.createElement('option');
        opt.value = o;
        opt.textContent = YK.ownerDisplayName(o);
        select.appendChild(opt);
      });

      // Read from URL param
      var params = new URLSearchParams(window.location.search);
      var initialOwner = params.get('owner');
      if (initialOwner && owners.includes(initialOwner)) {
        select.value = initialOwner;
      }

      select.addEventListener('change', function() {
        renderProfile(select.value);
        history.pushState(null, '', '?owner=' + select.value);
      });

      // Handle back/forward
      window.addEventListener('popstate', function() {
        var p = new URLSearchParams(window.location.search);
        var o = p.get('owner');
        if (o && owners.includes(o)) {
          select.value = o;
          renderProfile(o);
        }
      });

      function renderProfile(ownerKey) {
        var container = document.getElementById('team-profile');
        var color = YK.ownerColor(ownerKey);
        var displayName = YK.ownerDisplayName(ownerKey);

        // Find owner data from owners.json
        var ownerObj = (ownersData.owners || []).find(function(o) {
          return YK.resolveOwner(o.id) === ownerKey;
        });

        // === A. Profile Header ===
        var totalW = 0, totalL = 0, totalSeasons = 0, totalTitles = 0;
        var currentTeam = '';
        seasons.forEach(function(s) {
          s.standings.forEach(function(entry) {
            if (YK.teamToOwner(entry.team) === ownerKey) {
              totalW += entry.w;
              totalL += entry.l;
              totalSeasons++;
              if (s.champion === entry.team) totalTitles++;
              if (s.year === '2025-26') currentTeam = entry.team;
            }
          });
        });
        var totalPct = (totalW + totalL) > 0 ? totalW / (totalW + totalL) : 0;

        var headerHtml = '<div class="team-profile-header">';
        headerHtml += '<div class="color-bar" style="background:' + color + '"></div>';
        headerHtml += '<div class="profile-info">';
        headerHtml += '<div class="profile-name">' + displayName + '</div>';
        headerHtml += '<div class="profile-meta">' + (currentTeam || 'No current team') + ' &middot; ' + totalSeasons + ' season' + (totalSeasons !== 1 ? 's' : '');
        if (totalTitles > 0) headerHtml += ' &middot; ' + totalTitles + ' title' + (totalTitles !== 1 ? 's' : '');
        headerHtml += '</div>';

        // Ownership timeline for Baden
        if (ownerObj && ownerObj.franchiseHistory && ownerObj.franchiseHistory.length > 1) {
          headerHtml += '<div class="ownership-timeline">';
          var timelineColors = ['#4e79a7', '#f28e2b', '#59a14f'];
          ownerObj.franchiseHistory.forEach(function(era, idx) {
            headerHtml += '<div class="ownership-era" style="background:' + timelineColors[idx % 3] + ';flex:1">';
            headerHtml += era.owner + ' (' + era.period + ')';
            headerHtml += '</div>';
          });
          headerHtml += '</div>';
        }
        headerHtml += '</div>';
        headerHtml += '<div class="profile-record">';
        headerHtml += '<div class="big-num">' + totalW + '-' + totalL + '</div>';
        headerHtml += '<div class="rec-label">' + (totalPct * 100).toFixed(1) + '% All-Time</div>';
        headerHtml += '</div>';
        headerHtml += '</div>';

        // === B. Season-by-Season Record Table ===
        var seasonHtml = '<div class="chart-section">';
        seasonHtml += '<h2>&#x1F4C5; Season-by-Season Record</h2>';
        seasonHtml += '<div class="data-table-wrapper"><table class="data-table">';
        seasonHtml += '<thead><tr><th>Season</th><th>Team</th><th>Finish</th><th>Record</th><th>Win %</th><th>FPTS</th><th></th></tr></thead>';
        seasonHtml += '<tbody>';

        var seasonRows = [];
        seasons.forEach(function(s) {
          s.standings.forEach(function(entry) {
            if (YK.teamToOwner(entry.team) === ownerKey) {
              var isChamp = s.champion === entry.team;
              seasonRows.push({
                year: s.year,
                team: entry.team,
                rank: entry.rank,
                w: entry.w,
                l: entry.l,
                pct: entry.win_pct,
                fpts: entry.fpts,
                isChamp: isChamp,
                inProgress: s.in_progress,
              });
            }
          });
        });

        seasonRows.forEach(function(r) {
          seasonHtml += '<tr>';
          seasonHtml += '<td><strong>' + r.year + '</strong></td>';
          seasonHtml += '<td>' + r.team + '</td>';
          seasonHtml += '<td style="text-align:center">' + r.rank + (r.rank === 1 ? 'st' : r.rank === 2 ? 'nd' : r.rank === 3 ? 'rd' : 'th') + '</td>';
          seasonHtml += '<td style="text-align:center;font-weight:600">' + r.w + '-' + r.l + '</td>';
          seasonHtml += '<td style="text-align:center">' + (r.pct * 100).toFixed(1) + '%</td>';
          seasonHtml += '<td style="text-align:right">' + r.fpts.toLocaleString() + '</td>';
          seasonHtml += '<td style="text-align:center">';
          if (r.isChamp) seasonHtml += '<span class="badge badge-champ">Champ</span>';
          if (r.inProgress) seasonHtml += '<span class="badge badge-active">In Progress</span>';
          seasonHtml += '</td>';
          seasonHtml += '</tr>';
        });

        // Totals row
        if (seasonRows.length > 0) {
          seasonHtml += '<tr style="background:var(--bg-primary);font-weight:700;border-top:2px solid var(--border-strong)">';
          seasonHtml += '<td colspan="3"><strong>TOTAL</strong></td>';
          seasonHtml += '<td style="text-align:center">' + totalW + '-' + totalL + '</td>';
          seasonHtml += '<td style="text-align:center">' + (totalPct * 100).toFixed(1) + '%</td>';
          var totalFpts = seasonRows.reduce(function(sum, r) { return sum + r.fpts; }, 0);
          seasonHtml += '<td style="text-align:right">' + totalFpts.toLocaleString() + '</td>';
          seasonHtml += '<td>' + (totalTitles > 0 ? totalTitles + 'x Champ' : '') + '</td>';
          seasonHtml += '</tr>';
        }
        seasonHtml += '</tbody></table></div></div>';

        // === C. Trade Log ===
        var ownerTrades = tradesData.filter(function(trade) {
          var involved = false;
          (trade.give || []).concat(trade.get || []).forEach(function(item) {
            if (parseOwner(item) === ownerKey) involved = true;
          });
          return involved;
        });

        var tradeHtml = '<div class="chart-section">';
        tradeHtml += '<h2>&#x1F504; Trade Log (' + ownerTrades.length + ' trades)</h2>';
        if (ownerTrades.length === 0) {
          tradeHtml += '<p class="text-muted" style="padding:16px">No trades on record.</p>';
        } else {
          tradeHtml += '<div class="data-table-wrapper"><table class="data-table">';
          tradeHtml += '<thead><tr><th>Season</th><th>Date</th><th>Give</th><th>Get</th></tr></thead>';
          tradeHtml += '<tbody>';
          ownerTrades.forEach(function(trade) {
            var giveStr = (trade.give || []).map(function(g) {
              var owner = parseOwner(g);
              var clr = YK.ownerColor(owner);
              var last = (YK.ownerDisplayName(owner) || '').split(' ').pop();
              return '<div style="margin-bottom:2px"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:' + clr + ';margin-right:4px;vertical-align:middle"></span><span style="color:var(--text-muted);font-weight:600;font-size:0.75rem">' + escapeHtml(last) + '</span> ' + escapeHtml(parseAsset(g)) + '</div>';
            }).join('');
            var getStr = (trade.get || []).map(function(g) {
              var owner = parseOwner(g);
              var clr = YK.ownerColor(owner);
              var last = (YK.ownerDisplayName(owner) || '').split(' ').pop();
              return '<div style="margin-bottom:2px"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:' + clr + ';margin-right:4px;vertical-align:middle"></span><span style="color:var(--text-muted);font-weight:600;font-size:0.75rem">' + escapeHtml(last) + '</span> ' + escapeHtml(parseAsset(g)) + '</div>';
            }).join('');
            tradeHtml += '<tr>';
            tradeHtml += '<td><strong>' + trade.season + '</strong></td>';
            tradeHtml += '<td style="white-space:nowrap;color:var(--text-muted);font-size:0.8rem">' + (trade.date || '&mdash;') + '</td>';
            tradeHtml += '<td style="font-size:0.82rem">' + giveStr + '</td>';
            tradeHtml += '<td style="font-size:0.82rem">' + getStr + '</td>';
            tradeHtml += '</tr>';
          });
          tradeHtml += '</tbody></table></div>';
        }
        tradeHtml += '</div>';

        // === D. Draft Picks Owned ===
        var pickYears = Object.keys(picksData).sort();
        var picksHtml = '<div class="chart-section">';
        picksHtml += '<h2>&#x1F4CB; Draft Picks Owned</h2>';
        picksHtml += '<div class="data-table-wrapper" style="border:none">';
        picksHtml += '<div class="pick-grid" style="grid-template-columns: 100px repeat(' + pickYears.length + ', 1fr);">';

        // Header
        picksHtml += '<div class="pick-cell header">Year</div>';
        pickYears.forEach(function(yr) {
          picksHtml += '<div class="pick-cell header" style="text-align:center">' + yr + '</div>';
        });

        // Single row for this owner
        picksHtml += '<div class="pick-cell owner-name">Picks</div>';
        var totalOwnerPicks = 0;
        pickYears.forEach(function(yr) {
          var picks = (picksData[yr] && picksData[yr][ownerKey]) || [];
          totalOwnerPicks += picks.length;
          if (picks.length === 0) {
            picksHtml += '<div class="pick-cell pick-content" style="text-align:center;color:var(--text-muted)">&mdash;</div>';
          } else {
            var items = picks.map(function(p) {
              var is1st = p.toLowerCase().includes('1st');
              var cls = is1st ? 'pick-1st' : 'pick-2nd';
              var colorCls = classifyPick(p, ownerKey);
              return '<div class="pick-item ' + cls + ' ' + colorCls + '">' + escapeHtml(p) + '</div>';
            }).join('');
            picksHtml += '<div class="pick-cell pick-content">' + items + '</div>';
          }
        });

        picksHtml += '</div></div>';
        picksHtml += '<p class="chart-insight"><strong>' + totalOwnerPicks + '</strong> total picks across ' + pickYears[0] + '&ndash;' + pickYears[pickYears.length - 1] + '.</p>';
        picksHtml += '</div>';

        // === E. Current Roster ===
        var rosterHtml = '<div class="chart-section">';
        rosterHtml += '<h2>&#x1F4DD; Current Roster (2025-26)</h2>';

        var teamData = rosterData && rosterData.teams && rosterData.teams[ownerKey];
        if (!teamData || !teamData.players || teamData.players.length === 0) {
          rosterHtml += '<p class="text-muted" style="padding:16px">No roster data available.</p>';
        } else {
          var players = teamData.players.slice();
          // Sort by dynasty rank
          players.sort(function(a, b) {
            var ra = rankMap[normalizeName(a.name)];
            var rb = rankMap[normalizeName(b.name)];
            if (ra !== undefined && rb !== undefined) return ra - rb;
            if (ra !== undefined) return -1;
            if (rb !== undefined) return 1;
            return a.name.localeCompare(b.name);
          });

          rosterHtml += '<p class="chart-description">' + teamData.team_name + ' &middot; ' + players.length + ' players</p>';
          rosterHtml += '<div class="data-table-wrapper"><table class="data-table">';
          rosterHtml += '<thead><tr><th>Player</th><th>Pos</th><th>NBA Team</th><th>Status</th></tr></thead>';
          rosterHtml += '<tbody>';
          players.forEach(function(p) {
            var rank = rankMap[normalizeName(p.name)];
            var rankBadge = rank !== undefined
              ? ' <span style="background:rgba(232,184,75,0.18);color:#c7960a;font-size:0.68rem;font-weight:800;padding:1px 5px;border-radius:99px;margin-left:4px">#' + rank + '</span>'
              : '';
            rosterHtml += '<tr>';
            rosterHtml += '<td><strong>' + escapeHtml(p.name) + '</strong>' + rankBadge + '</td>';
            rosterHtml += '<td style="color:var(--text-muted)">' + escapeHtml(p.pos || '—') + '</td>';
            rosterHtml += '<td style="color:var(--text-muted)">' + escapeHtml(p.nbaTeam || '—') + '</td>';
            rosterHtml += '<td>' + statusBadge(p.status) + '</td>';
            rosterHtml += '</tr>';
          });
          rosterHtml += '</tbody></table></div>';
        }
        rosterHtml += '</div>';

        // Combine all sections
        container.innerHTML = headerHtml + seasonHtml + tradeHtml + picksHtml + rosterHtml;
      }

      // Render initial profile
      renderProfile(select.value);
    })();
  </script>
</body>
</html>
